<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>增加上线计划</title>
    <link rel="stylesheet" type="text/css" href="../static/src/css/layui.css"/>
    <link rel="stylesheet" type="text/css" href="../static/css/formSelects-v4.css"/>
    <script src="../static/src/layui.all.js" type="text/javascript" charset="utf-8"></script>
    <script src="../static/src/public.js" type="text/javascript" charset="utf-8"></script>
    <script src="../static/js/common.js" type="text/javascript" charset="utf-8"></script>
    <script src="../static/js/formSelects-v4.js" type="text/javascript" charset="utf-8"></script>
    <style type="text/css">
        body {
            padding: 20px;

        }
    </style>
</head>
<body>
<div class="wrap-container">
    <form name="form" class="layui-form" method="post" action="" id="add_onplan_form">

        <div class="layui-form-item" style="display:none">
            <label class="layui-form-label">上线计划id：</label>
            <div class="layui-input-block">
                <input type="text" name="id" id="id" readonly="" autocomplete="off" class="layui-input"
                       style="background-color: #f2f2f2"/>
            </div>
        </div>

        <div class="layui-form-item" style="display:none">
            <label class="layui-form-label">需求标题：</label>
            <div class="layui-input-block">
                <input type="text" name="reqNo" id="reqNo" readonly="" autocomplete="off" class="layui-input"
                       style="background-color: #f2f2f2"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">需求标题：</label>
            <div class="layui-input-block">
                <input type="text" name="reqName" id="reqName" readonly="" autocomplete="off" class="layui-input"
                       style="background-color: #f2f2f2"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">上线时间：</label>
            <div class="layui-input-block">
                <input type="text" id="onplan_date" placeholder="选择完上线时间后才能选择功能点" name="onlineDatetime"
                       autocomplete="off" class="layui-input"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">功能点:</label>
            <div class="layui-input-block">
                <select name="funcId" id="funcId" xm-select="selectFunc" disabled="" xm-select-show-count="4"
                        xm-select-height="36px">
                </select>
            </div>
        </div>

        <div class="layui-form-item" style="display:none">
            <label class="layui-form-label">功能点名称:</label>
            <div class="layui-input-block">
                <input type="text" name="funcItem" id="funcItem" autocomplete="off" class="layui-input"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">任务编号：</label>
            <div class="layui-input-block">
                <input type="text" id="devNo" name="devNo" lay-verify="pass"
                       placeholder="请输入任务编号" autocomplete="off" class="layui-input"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">计划名称：</label>
            <div class="layui-input-block">
                <input type="text" name="onlinePlanName" lay-verify="title"
                       placeholder="请输入计划名称" autocomplete="off" class="layui-input"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">计划描述：</label>
            <div class="layui-input-block">
                <input type="text" id="onlinePlanDesc" name="onlinePlanDesc" lay-verify="title"
                       placeholder="请输入计划描述" autocomplete="off" class="layui-input"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">计划状态：</label>
            <div class="layui-input-block">
                <input type="text" id="onlinePlanStatus" name="onlinePlanStatus"
                       placeholder="请输入计划状态" autocomplete="off" class="layui-input"/>
            </div>
        </div>

        <div class="layui-form-item" style="display:none">
            <label class="layui-form-label">操作人：</label>
            <div class="layui-input-block">
                <input type="text" name="opPerson" id="opPerson" readonly='' autocomplete="off" class="layui-input"/>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block" style="float: right">
                <button type="button" class="layui-btn layui-btn-primary" id="close">关闭</button>
                <button class="layui-btn" id="add_form_btn" lay-submit="" lay-filter="add_form_btn">立即提交</button>
            </div>
        </div>
    </form>
</div>

<!-- 判断是否为空 -->
<script>
    layui.use(['form', 'jquery', 'laydate'], function () {
        var form = layui.form;
        var $ = layui.jquery;
        var laydate = layui.laydate;
        form.verify({
            pass: function (value) {
                if (value.length == 0) {
                    return '此项为必输项';
                }
            }
        });
        form.render();

        //获取cookie中的用户名
        showName('opPerson', 'name');
        redata = JSON.parse(decodeURIComponent(getRequestParam().obj));


        //监听提交
        form.on('submit(add_form_btn)', function (data) {
            // layer.alert(JSON.stringify(data.field));
            $.ajax({
                url: '/updateOnlinePlan',
                data: data.field,
                type: 'POST',//默认以get提交，以get提交如果是中文后台会出现乱码
                dataType: 'json',
                success: function (obj) {

                    if (obj == 'success') {
                        pubUtil.msg("编辑成功", layer, 1, function () {
                            $("#close").click();
                        }, 1000);
                    } else {
                        pubUtil.msg("编辑失败", layer, 2, function () {

                        }, 1000);
                    }
                }
            });
            return false;
        });

        // 请求之前添加的功能点
        namestr = [];
        // $.ajax({
        //     url: "/",
        //     type: "GET",
        //     data:{
        //         id:redata.id, page:1, limit:10000
        //     },
        //     dataType:"json",
        //     success: function (resData) {
        //         /*<![CDATA[*/
        //         for(var i =0;i<resData.data.total;i++){
        //             namestr.push(resData.data.list[i].id);
        //         }
        //         /*]]>*/
        //         return namestr;
        //     }
        // });

        // 上线时间选择
        var onplanDate = laydate.render({
            elem: '#onplan_date',//选择器结束时间
            theme: 'molv',
            min: "1970-1-1",//设置min默认最小值
            max: "2099-12-31",
            done: function (value, date, endate) {
                console.log(value);
                onplanDate = value;
                if (value.length != 0) {

                    $("#onplan_date").css('background', '#f2f2f2');
                    document.getElementById("onplan_date").disabled = true;

                    document.getElementById("funcId").disabled = false;
                    // $("#onplan_date").css('background', '#fff')
                    //直接放在点击监听判断语句里就不生效？？？
                    layui.formSelects.data('selectFunc', 'server', {
                        url: "/listFunc"
                        , data: {
                            page: 1,
                            limit: 10000,
                            onplanDate: value
                        }
                        , keyVal: 'id'
                        , keyName: 'funcName'
                        , beforeSuccess: function (id, url, searchVal, result) {
                            result = result.data.list;
                            return result;
                        }
                        , success: function (id, url, searchVal, result) {      //使用远程方式的success回调

                            formSelects.value(id, namestr);
                        },
                    });
                }
            }
        });

        // 监听下拉框的关闭
        layui.formSelects.closed('selectFunc', function (id) {
            console.log(layui.formSelects.value('selectFunc', 'nameStr'));
            $('#funcItem').val(layui.formSelects.value('selectFunc', 'nameStr'));
        });

    });
</script>


</body>
</html>